<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Optimization Structure - SUAVE</title>
	<meta name="description" content="Optimization Code Structure">

	<link rel="stylesheet" href="/css/main.css">
	<link rel="canonical" href="http://localhost:4000/guides/optimization.html">
	<link rel="alternate" type="application/rss+xml" title="SUAVE" href="http://localhost:4000/feed.xml" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	<script src="http://momentjs.com/downloads/moment.js" type="text/javascript"></script>
	<script src="/js/main.js" type="text/javascript"></script>
</head>

	
<!--	<a href="https://github.com/suavecode/SUAVE"><img style="position: absolute; z-index: 10; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>-->
	<body>

	<div class="page-content">
		<div class="wrapper">
			<aside class="left-nav">
			<div class="verticalLineL">
				&nbsp
	<a href="/" class="logo"><img src="/images/logo.svg" alt="SUAVE Code"><span>SUAVE</span></a>

	<section>
		<h1 class="greetings"></h1>
		<p>A multi-fidelity conceptual design environment. Its purpose is to credibly produce conceptual-level design conclusions for future aircraft incorporating advanced technologies.</p>

	</section>
	<nav class="main-nav">
		<ul>
		<li><a class="btn page-link " href="/">About</a></li>
		<li><a class="btn page-link " href="/download/">Download</a></li>
		<li><a class="btn page-link active" href="/guides/">Tutorials</a></li>
		<li><a class="btn page-link active" href="/documentation/">Documentation</a></li>
		<li><a class="btn page-link " href="/develop/">Develop</a></li>
		<li><a class="btn page-link " href="/forum/">Forum</a></li>
		
		</ul>
	</nav>


            <footer>
	<div class="social-media-list">
		<a class="social-media-link" href="https://github.com/suavecode/SUAVE">
            <span class="icon  icon-github">
                <img src="/images/github.svg">
            </span>
		</a> 
        
	    <a class="social-media-link" href="https://travis-ci.org/suavecode/SUAVE">
            <span class="icon  icon-travis">
                <img src="/images/travis.svg">
            </span>
		</a>

		
		
	</div>
        
    <br>
    
	<small>Copyright &copy; 2017 <br> Stanford Aerospace Design Lab <br> All rights reserved</small>
</footer>

			
			</aside>
			<main class="main-content">
			<div class="single-post">

	<div class="verticalLineR">

	<header class="hero">
	<div class="valign">
		<h1 class="title">Optimization Structure</h1>
	</div>
	</header>

	<article class="content">
	<h2 id="optimization-code-structure">Optimization Code Structure</h2>

<p>This is an overview of how optimization is done in SUAVE. A specific tutorial case is also available <a href="/guides/regional_jet_optimization.html">here</a>.</p>

<h3 id="nexus-class">Nexus Class</h3>

<p>The Nexus class is the underlying data structure that is used for optimization. It is created to hold all data and functionality needed to link together optimizers and the various analysis modules in SUAVE. Detailed information on each of the functions can be found on our <a href="/doxygen">doxygen page</a>.</p>

<h3 id="standard-optimization-file-structure">Standard Optimization File Structure</h3>

<p>These are the standard files that are used in the optimization process. They are typically stored as Optimize.py, Vehicle.py, Analysis.py, Mission.py, Procedure.py, and Plot_Mission.py. These names can be changed if desired.</p>

<h4 id="optimize">Optimize</h4>

<p>This is the top level file that is run to perform the optimization. Inputs, objective, constraints, and aliases are specified here. The inputs have an initial value, bounds, a scaling factor, and the units used. This provides later functions with the information needed to vary the parameters. Units.less indicates a unitless quantity. SI units are the default in SUAVE’s internal calculations, so Units.meter will not modify the internal value, while something like Units.foot will.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>problem.inputs = np.array([
    [ 'wing_area'     ,  125.  , (   120.   ,   180.   )  ,   100.  , Units.meter**2],
    [ 'aspect_ratio'  ,  3.3   , (   2.0    ,   6.0    )  ,   10.   , Units.less],
])
</code></pre></div></div>

<p>Constraints and the objective are similar. Both have scaling quantities and constraints also have bounds.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>problem.constraints = np.array([
    [ 'design_range_fuel_margin', '&gt;', 0., 1E-1, Units.less]
])

problem.objective = np.array([
    ['fuel_burn_rate', 1., Units.kg/Units.s]
])
</code></pre></div></div>

<p>Finally we have aliases. This provides the optimization process with the position of the various parameters in the data structure. Aliases are used so that short names can be used for variables and a single variable can control multiple items in the data structure. Controlling multiple items can be important if different vehicle configurations are used at different points in the mission, and one of the vehicle parameters should change in the same way for all of the configurations. We can use * as a wildcard. This is used below to change the aspect ratio of the main wing in every vehicle configuration.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>problem.aliases = [
    [ 'wing_area'       ,   ['vehicle_configurations.base.wings.main_wing.areas.reference',
                                              'vehicle_configurations.base.reference_area']],
    [ 'aspect_ratio'    ,    'vehicle_configurations.*.wings.main_wing.aspect_ratio'       ],
    [ 'fuel_burn_rate'  ,    'summary.fuel_burn_rate'                                      ],
]    
</code></pre></div></div>

<p>This file then specifies the configurations, analyses, missions, and procedure that will be used. This are typically contained in separate files and more details on each are below. Once all of this is specified, the desired optimizer is called with the nexus class created by this setup.</p>

<h4 id="vehicle-setup">Vehicle Setup</h4>

<p>This contains the vehicle information such as geometric data and configurations. It is the same as the vehicle setup used for basic analysis purposes.</p>

<h4 id="analysis-setup">Analysis Setup</h4>

<p>This contains information on what analyses should be run for the vehicle. For example if correlation-based aerodynamics or AVL should be used for computations. It requires vehicle information from the previous step.</p>

<h4 id="mission-setup">Mission Setup</h4>

<p>This is also the same as the standard mission setup. It determines how the mission will be flown. It requires analysis information from the previous step.</p>

<h4 id="procedure">Procedure</h4>

<p>This is an optimization specific file that determines how the vehicle, analysis, or mission is modified with the input values in the optimization and also runs the mission. For example, changing the wing area will usually require changes to other wing parameters, such as root chord length. This module reads the new inputs and changes other values accordingly based on user specified processes.</p>

<h4 id="plotting">Plotting</h4>

<p>This function is not necessary to the optimization, but is often included in the files used and is added to the optimize main call as a way to visualize the results.</p>

<h3 id="optimizer-interface">Optimizer Interface</h3>

<p>The other step that must be taken to perform an optimization is to convert the standardized input above into values that can be used by the selected optimizer. This is done through a separate script for each optimizer, all of which are found in the <a href="doxygen_link_here">optimization folder</a>.</p>

<p>For example, if we are using PyOpt to optimize, we might use <code class="highlighter-rouge">output = pyopt_setup.Pyopt_Solve(problem,solver='SNOPT')</code> in the main function of the top level optimizer. This function reads the inputs, constraints, and objective and converts them to a format that the selected optimizer (SNOPT here) can understand.</p>

<h3 id="evaluation-process">Evaluation Process</h3>

<p>This shows the typical evaluation process, including where items like inputs and aliases are used. This chart assumes a single objective call, but some optimizers will include calls such as <code class="highlighter-rouge">all_constraints</code> which require another evaluation. If the evaluation is a duplicate, data from the previous evaluation will be used instead of stepping through the procedure again.</p>

<p> </p>

<p><img src="http://suave.stanford.edu/images/opt_flow.png" width="600" height="338" /></p>

<p> </p>

<h3 id="incorporating-multi-fidelity">Incorporating Multi-fidelity</h3>

<p>Multiple levels of fidelity are designed to be relatively easy to incorporate in SUAVE, but there are still a few things to keep in mind. First, the chosen optimizer must support multi-fidelity and be able to change the <code class="highlighter-rouge">nexus.fidelity_level</code> value. Once this is done, it is also important to remember that the mission is set up based on the analyses. This means that if a change is made to  the analyses then the mission must be rebuilt with the new settings. As an example, code below for changing the analysis level is shown. This is a function that has been added to the procedure file.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def set_fidelity_level(nexus):
    
    if nexus.has_key('fidelity_level') == False:
        print 'Fidelity level not set, defaulting to 1'
        nexus.fidelity_level = 1

    if nexus.fidelity_level == 2:
        aerodynamics = SUAVE.Analyses.Aerodynamics.Supersonic_OpenVSP_Wave_Drag()
        aerodynamics.settings.number_slices    = 20
        aerodynamics.settings.number_rotations = 10        
    elif nexus.fidelity_level == 1:
        aerodynamics = SUAVE.Analyses.Aerodynamics.Supersonic_Zero()
    else:
        raise ValueError('Selected fidelity level not supported')
    aerodynamics.geometry = copy.deepcopy(nexus.vehicle_configurations.base)
    nexus.analyses.base.append(aerodynamics)
    
    nexus.missions = mission_as2.setup(nexus.analyses)
    
    return nexus
</code></pre></div></div>

<p>Here we see that <code class="highlighter-rouge">nexus.missions</code> has been updated in addition to <code class="highlighter-rouge">nexus.analyses</code>, since failing to do this would have the mission run with the previous analysis settings.</p>

<h3 id="key-functions-in-the-optimizer-setup">Key Functions in the Optimizer Setup</h3>

<p>We briefly mentioned how optimization parameters would need to be converted so that they could run with a particular optimizer. Here we show how this is managed and show which functions are likely to be useful in building a new optimizer setup.</p>

<p>The key items that will be needed for most optimizers are shown below, taken from the PyOpt setup:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inp = problem.optimization_problem.inputs
obj = problem.optimization_problem.objective
con = problem.optimization_problem.constraints  
   
# Set inputs
nam = inp[:,0] # Names
ini = inp[:,1] # Initials
bnd = inp[:,2] # Bounds
scl = inp[:,3] # Scale
typ = inp[:,4] # Type
</code></pre></div></div>

<p>These can be scaled with two helper functions that are part of the SUAVE distribution:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from SUAVE.Optimization import helper_functions as help_fun

bnd_constraints    = help_fun.scale_const_bnds(con)
scaled_constraints = help_fun.scale_const_values(con,bnd_constraints)
x                  = ini/scl
</code></pre></div></div>

<p>What happens next is entirely dependent on what optimizer you want to use. Some may require that constraint bounds happen at 0 or are either &gt; or &lt;. However this setup is done, you will likely need to create a function that can accept the problem and inputs and give required outputs such as the objective value and constraints. In the PyOpt case, this is done with a simple wrapper and an added function:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mywrap = lambda x:PyOpt_Problem(problem,x)
</code></pre></div></div>

<p>…</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def PyOpt_Problem(problem,x):
   
	obj   = problem.objective(x)
	const = problem.all_constraints(x).tolist()
	fail  = np.array(np.isnan(obj.tolist()) or np.isnan(np.array(const).any())).astype(int)

   
	print 'Inputs'
	print x
	print 'Obj'
	print obj
	print 'Con'
	print const
   
	return obj,const,fail
</code></pre></div></div>

<p>Please visit our <a href="/forum">forum</a> if you have any other questions on how the optimizer interface works or how to convert the values to what you need.</p>

	</article>

	<div class="content">
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES * * */
			var disqus_shortname = '';
			var disqus_identifier = 'http://localhost:4000/guides/optimization.html';

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div>

</div>

			
			</main>
			
		</div>
	</div>
	

	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', '', 'auto');
	ga('send', 'pageview');

</script>

<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES * * */
	var disqus_shortname = '';

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function () {
	var s = document.createElement('script'); s.async = true;
	s.type = 'text/javascript';
	s.src = '//' + disqus_shortname + '.disqus.com/count.js';
	(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
	}());
</script>


	</body>
	
</html>
